
# STM32 Embedded Project

## ТЗ

Задание звучало как "переписание кода модема и блютуз-адаптера на Python". Python не может эффективно использоваться на микроконтроллерах нативно*, так как для него требуется тяжелая виртуальная машина-строковый интерпретатор, сборка мусора, runtime, и неимоверное количество памяти под самые простые структуры. Было принято решение интегрировать вместе Rust, C и Python. Rust будет использоваться для системных функций МК, C - для написания бизнес-логики и обратной совместимости, а Python - для генерации кода на C (т.е. будет получаться читаемый и понятный код на Python, который будет транслироваться в C), написания автотестов и сопутствующих задач анализа и визуализации полученных с МК данных в реальном времени.

* За исключеним MicroPython, который используется в основном для Raspberry PI Pico, и, по сути, предназначен для радиолюбительства

### Пояснение на примере:

К примеру, требуется написать приложение для stm32, к которому подключены два датчика - давления и температуры.
На МК работает простая операционная система реального времени на rust и assembly (TODO), которая делит время процессора на несколько задач - например, две задачи для собирания показаний датчиков + одна дополнительная задача, ответственная за связь посредством UART с ПК по определенному протоколу для передачи значений датчиков. Каждая задача может быть написана как на rust, так и на C - для системных задач предпочтение отдается rust (например, вызов функций API, сгенерированного svd2rust),  для бизнес-логики - C (так как остальные программисты здесь используют только его, в будующем планируется также написать генератор проекта на uKeil).

Пишется код на Python, который задает параметры каждой задачи, код транслируется в C. TODO

## Описание текущего проекта

Это прототип проекта, реализующий интеграцию кода Python, Rust и C на МК.

Проект предназначен для работы на микроконтроллере STM32, к которому подключены два датчика: давления и температуры. На микроконтроллере работает простая операционная система реального времени, написанная на Rust с использованием вставок на Assembly. ОС делит время процессора на несколько задач:
- Сбор показаний датчиков давления и температуры.
- Связь с ПК посредством UART для передачи значений датчиков.

## Структура проекта

```
.
├── rust_project               # Код на Rust
│   ├── src
│   │   ├── main.rs            # Основной файл
│   │   ├── lib.rs             # Библиотека с функциями и API
│   │   └── asm                # Вставки на Assembly
│   ├── Cargo.toml             # Конфигурационный файл Cargo
│   ├── build.rs               # Сценарий сборки для включения C-кода
│   └── .cargo
│       └── config.toml        # Локальная конфигурация Cargo
├── c_project                  # Код на C
│   ├── main.c                 # Основной файл
│   └── business_logic.c       # Бизнес-логика
├── python_project             # Код на Python для генерации C-кода
│   ├── main.py                # Основной файл
│   └── templates              # Шаблоны для генерации C-кода
├── Cargo.toml                 # Основной конфигурационный файл Cargo
├── memory.x                   # Файл с описанием памяти
└── README.md                  # Документация проекта
```

## Установка и настройка

1. Установите Rust и Cargo:
   ```bash
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   source $HOME/.cargo/env
   ```

2. Установите необходимые инструменты:
   ```bash
   cargo install cargo-edit
   ```

3. Установите зависимости:
   ```bash
   cargo add serde
   cargo add cortex-m cortex-m-rt cortex-m-rtic panic-halt
   ```

4. Настройте проект для работы с `svd2rust`:
   ```bash
   cargo install svd2rust
   ```

5. Сгенерируйте API с помощью `svd2rust`:
   ```bash
   svd2rust -i path/to/your.svd
   form -i lib.rs -o src
   ```

## Сборка и запуск

1. Сборка проекта:
   ```bash
   cargo build --target thumbv7em-none-eabihf
   ```

2. Загрузка прошивки на МК:
   Используйте ваш загрузчик или отладчик для загрузки прошивки на микроконтроллер.

## Пример кода

### Основной файл на Rust

```rust
#![no_std]
#![no_main]

extern crate panic_halt;

extern "C" {
    fn business_logic();
}

#[cortex_m_rt::entry]
fn main() -> ! {
    unsafe {
        business_logic();
    }

    loop {}
}
```

### Основной файл на C

```c
#include <stdio.h>

void business_logic() {
    // Ваш бизнес-код на C
    printf("Hello from C business logic!\n");
}
```

### Основной файл на Python для генерации C-кода

```python
def generate_c_code():
    template = """
    #include <stdio.h>

    void business_logic() {
        // Generated business logic
        printf("Hello from generated C business logic!\n");
    }
    """
    with open('c_project/business_logic.c', 'w') as f:
        f.write(template)

if __name__ == "__main__":
    generate_c_code()
```

## Контрибьюторы

- Илья Барынкин.
- Ха-ха, очень смешно.

## Лицензия

TODO
